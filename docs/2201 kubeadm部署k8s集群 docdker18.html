<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600554 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="6431"/>

<div>
<span><div># 部署环境</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>192.168.16.30 t0 t0.wft.com master节点</div><div>192.168.16.31 t1 t1.wft.com node1节点</div><div>192.168.16.32 t2 t2.wft.com node2节点</div><div>192.168.16.33 t3 t3.wft.com node3节点</div><div>192.168.16.36 t6 t6.wft.com 代理节点,你懂的</div></div><div><br/></div><div># 环境初始化</div><div>## 配置hosts</div><div>vim /etc/hosts</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>192.168.16.30 t0 t0.wft.com</div><div>192.168.16.31 t1 t1.wft.com</div><div>192.168.16.32 t2 t2.wft.com</div><div>192.168.16.33 t3 t3.wft.com</div><div>192.168.16.36 t6 t6.wft.com</div></div><div><br/></div><div>## 配置yum源</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>yum -y install epel-release</div><div>yum clean all</div><div>yum -y groupinstall 'Compatibility libraries' &quot;Base&quot; &quot;Development tools&quot;</div><div>yum -y groupinstall &quot;debugging Tools&quot; &quot;Dial-up Networking Support&quot;</div><div>yum -y install lrzsz  bash-completion</div><div>yum -y install iptables-services</div><div>yum -y install python-pip</div></div><div><br/></div><div>## 关闭selinux</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>setenforce 0 </div><div>sed -i '/SELINUX/s/enforcing/disabled/' /etc/selinux/config</div></div><div><br/></div><div>## 时区配置与时间同步配置</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime </div><div>ntpdate ntp1.aliyun.com </div><div>echo &quot;*/5 * * * * /usr/sbin/ntpdate ntp1.aliyun.com&quot; &gt;&gt; /var/spool/cron/root</div></div><div><br/></div><div>## 防火墙配置</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>setenforce 0</div><div>systemctl stop firewalld</div><div>systemctl disable firewalld</div><div>setenforce 0</div><div>iptables -F</div><div>iptables -F -t nat</div><div>iptables -X</div><div>iptables -Z</div><div>service iptables save</div><div>systemctl restart iptables</div></div><div><br/></div><div><br/></div><div>-----------------------------------------------</div><div># 代理服务器配置(192.168.16.36)</div><div>由于不可描述原因，我们身处世界上最大的局域网之中，需要配置个代理服务帮我们完成软件包下载工作</div><div>部署使用到两个软件包：</div><div>shadowsocks-2.8.2.tar.gz</div><div>privoxy-3.0.26</div><div><br/></div><div>链接：<a href="https://pan.baidu.com/s/1WItdWg6_bMsbkJ_q9zcIPA">https://pan.baidu.com/s/1WItdWg6_bMsbkJ_q9zcIPA</a></div><div>提取码：edlo</div><div><br/></div><div>## 体面提供两种办法进行安装shadowsocks小飞机</div><div>第一种在线安装:</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>pip install shadowsocks</div></div><div><br/></div><div>第二种离线安装:</div><div>若第一种办法因不可描述原因安装失败可用离线安装办法</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># 创建安装包存放目录</div><div>mkdir /home/sha-client</div><div><br/></div><div># 下载安装包，上传到/home/sha-client</div><div>链接：https://pan.baidu.com/s/1WItdWg6_bMsbkJ_q9zcIPA</div><div>提取码：edlo</div><div><br/></div><div># 安装sha客户端</div><div>pip install --no-index --find-links=/home/sha-client shadowsocks</div></div><div><br/></div><div>## 配置shadowsocks连接文件</div><div>帐号密码这个需要自己花点心思,你们懂的</div><div>mkdir /etc/shadowsocks</div><div>vim /etc/shadowsocks/shadowsocks.json</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>{</div><div>    &quot;server&quot;:&quot;23.133.64.3&quot;,     # 梯子服务器密码</div><div>    &quot;server_port&quot;:24793,         # 梯子服务器端口</div><div>    &quot;local_address&quot;: &quot;127.0.0.1&quot;,  # 本地ip地址</div><div>    &quot;local_port&quot;:1080,             # 本地端口</div><div>    &quot;password&quot;:&quot;MLWJYQi&quot;,         # 连接密码</div><div>    &quot;timeout&quot;:300,                # 等待超时时间</div><div>    &quot;method&quot;:&quot;rc4-md5&quot;,            # 加密方式</div><div>    &quot;fast_open&quot;: false,         # 是否降低延迟</div><div>    &quot;workers&quot;: 1                 # 进程数</div><div>}</div></div><div><br/></div><div>## 配置启动文件</div><div>vim /etc/systemd/system/shadowsocks.service</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[Unit]</div><div>Description=Shadowsocks</div><div>[Service]</div><div>TimeoutStartSec=0</div><div>ExecStart=/usr/bin/sslocal -c /etc/shadowsocks/shadowsocks.json</div><div>[Install]</div><div>WantedBy=multi-user.target</div></div><div><br/></div><div>## 启动服务</div><div>systemctl enable shadowsocks.service</div><div>systemctl restart shadowsocks.service</div><div>systemctl status shadowsocks.service</div><div><br/></div><div>## 验证是否可用</div><div>curl --socks5 127.0.0.1:1080 <a href="http://httpbin.org/ip">http://httpbin.org/ip</a></div><div>下面为返回正常结果</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>{</div><div>  &quot;origin&quot;: &quot;服务器地址&quot;</div><div>}</div></div><div><br/></div><div>## 安装privoxy，用来代理k8s下载请求</div><div>yum install privoxy -y</div><div><br/></div><div>## 修改配置文件</div><div>vim /etc/privoxy/config</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># 如果只为本机代理此处不用改，8118端口就是接受代理docker代理请求的端口</div><div># 如果为其他主机进行代理的话需要修改成listen-address  0.0.0.0:8118</div><div>listen-address  127.0.0.1:8118</div><div>forward-socks5t / 127.0.0.1:1080 .</div></div><div><br/></div><div>## 启动</div><div>systemctl enable privoxy</div><div>systemctl start privoxy</div><div>systemctl status privoxy</div><div><br/></div><div>## 测试是否可以请求</div><div>curl 192.168.16.36:8118</div><div>正常返回</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>Invalid header received from client.</div></div><div><br/></div><div># 验证是否成功部署好代理</div><div>## 在/etc/profile添加如下内容</div><div>vim /etc/profile</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>PROXY_HOST=127.0.0.1</div><div>export all_proxy=http://$PROXY_HOST:8118</div><div>export ftp_proxy=http://$PROXY_HOST:8118</div><div>export https_proxy=http://$PROXY_HOST:8118</div><div>export http_proxy=http://$PROXY_HOST:8118</div></div><div><br/></div><div># 刷新变量</div><div>export no_proxy=localhost,172.16.0.0/16,192.168.0.0/16.,127.0.0.1,10.10.0.0/16</div><div>source /etc/profile</div><div><br/></div><div># 测试</div><div>curl -I <a href="http://www.google.com/">www.google.com</a></div><div><br/></div><div># 取消代理方法</div><div>while read var; do unset $var; done &lt; &lt;(env | grep -i proxy | awk -F= '{print $1}')</div><div>去掉/etc/profile添加的内容</div><div>刷新变量</div><div>source /etc/profile</div><div><br/></div><div>-------------------------------------</div><div><br/></div><div># 配置docker的yum源</div><div>cd /etc/yum.repos.d</div><div>wget <a href="https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo">https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</a></div><div><br/></div><div># 配置k8s的yum源</div><div>vim kubernetes.repo</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[kubernetes]</div><div>name=k8s</div><div>baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</div><div>gpgcheck=0</div><div>enable=1</div></div><div>yum repolist</div><div><br/></div><div>==============master节点安装========================</div><div>## 配置docker的yum源</div><div>cd /etc/yum.repos.d</div><div>wget <a href="https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo">https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</a></div><div><br/></div><div>## 安装docker-ce的16.06版本</div><div>yum list docker-ce --showduplicates | sort -r</div><div>yum install docker-ce-18.06.0.ce-3.el7</div><div><br/></div><div># 将docker源修改为阿里云镜像加速器</div><div>mkdir /etc/docker/</div><div>vim /etc/docker/daemon.json</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>{</div><div>&quot;registry-mirrors&quot;: [&quot;<a href="https://88a45eyb.mirror.aliyuncs.com/">https://88a45eyb.mirror.aliyuncs.com&quot;,&quot;https://registry.docker-cn.com</a>&quot;],</div><div>&quot;dns&quot;: [&quot;223.5.5.5&quot;,&quot;223.6.6.6&quot;],</div><div>&quot;data-root&quot;: &quot;/data/docker&quot;</div><div>}</div></div><div><br/></div><div>## 打开ipvs转发功能</div><div>vim /etc/sysconfig/modules/ipvs.modules</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>#!/bin/bash</div><div>ipvs_mods_dir=&quot;/usr/lib/modules/$(uname -r)/kernel/net/netfilter/ipvs&quot;</div><div><br/></div><div>for i in $(ls $ipvs_mods_dir | grep -o &quot;^[^.]*&quot;); do</div><div>    /sbin/modinfo -F filename $i &amp;&gt; /dev/null</div><div>    if [ $? -eq 0 ]; then</div><div>        /sbin/modprobe $i</div><div>    fi    </div><div>done</div></div><div>chmod +x /etc/sysconfig/modules/ipvs.modules</div><div>/etc/sysconfig/modules/ipvs.modules</div><div><br/></div><div>##  配置docker使用代理</div><div>vim /usr/lib/systemd/system/docker.service</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># 在ExecStart=/usr/bin/dockerd下面添加如下行</div><div>ExecStartPost=/usr/sbin/iptables -P FORWARD ACCEPT</div><div><br/></div><div># 在ExecReload=/bin/kill -s HUP $MAINPID添加如下行</div><div>Environment=&quot;HTTPS_PROXY=http://t6.wft.com:8118&quot;</div><div>Environment=&quot;NO_PROXY=127.0.0.0/8,192.168.0.0/24,192.168.16.0/24&quot;</div></div><div><br/></div><div>systemctl enable docker</div><div>systemctl daemon-reload</div><div>systemctl restart docker</div><div><br/></div><div>## 测试是否可以通过代理下载镜像</div><div>docker pull k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1</div><div><br/></div><div>## 查看内核参数是否已经被修改如下</div><div>cat /proc/sys/net/bridge/bridge-nf-call-iptables</div><div>1   结果必须为1</div><div>cat /proc/sys/net/bridge/bridge-nf-call-ip6tables</div><div>1    结果必须为1</div><div><br/></div><div>## 配置k8s的yum源</div><div>vim kubernetes.repo</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[kubernetes]</div><div>name=k8s</div><div>baseurl=<a href="https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/">https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</a></div><div>gpgcheck=0</div><div>enable=1</div></div><div>yum repolist</div><div><br/></div><div>## 安装k8s组件</div><div>yum install kubelet kubeadm kubectl</div><div><br/></div><div>## 配置kubelet</div><div>vim /etc/sysconfig/kubelet</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>KUBELET_EXTRA_ARGS=&quot;--fail-swap-on=false&quot;</div></div><div><br/></div><div>## 初始化master</div><div>初始化kubeadm (帮助   kubeamd init --help)</div><div>kubeadm init --pod-network-cidr=10.244.0.0/16 --service-cidr=10.96.0.0/12 --ignore-preflight-errors=Swap</div><div>参数说明:</div><div>--apiserver-advertise-address string     api server监听地址,默认0.0.0.0</div><div>--apiserver-bind-port                            api server监听端口,默认6443</div><div>--cert-dir                                                加载证书的目录,default &quot;/etc/kubernetes/pki&quot;</div><div>--ignore-preflight-errors                       预检查需要忽略的报错Example: 'IsPrivilegedUser,Swap'. Value 'all' ignores errors from all checks.</div><div>--kubernetes-version                            kubernetes版本，默认不用加，如果要看就注意使用rpm -qa | grep kube查看</div><div>--pod-network-cidr                              pod使用的网络</div><div>--service-cidr                                        service使用的网络</div><div>################</div><div>注意初始化失败可以使用此命令恢复环境 kubeadm reset</div><div><br/></div><div>过程需要几分钟时间,主要取决于网络,成功后返回以下信息,需要将此信息保留。</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[root@t0 ~]# kubeadm init --pod-network-cidr=10.244.0.0/16 --service-cidr=10.96.0.0/12 --ignore-preflight-errors=Swap</div><div>I0303 15:07:33.747229   17893 version.go:94] could not fetch a Kubernetes version from the internet: unable to get URL &quot;https://dl.k8s.io/release/stable-1.txt&quot;: Get https://dl.k8s.io/release/stable-1.txt: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)</div><div>I0303 15:07:33.747311   17893 version.go:95] falling back to the local client version: v1.13.3</div><div>[init] Using Kubernetes version: v1.13.3</div><div>[preflight] Running pre-flight checks</div><div>        [WARNING Service-Docker]: docker service is not enabled, please run 'systemctl enable docker.service'</div><div>        [WARNING Swap]: running with swap on is not supported. Please disable swap</div><div>        [WARNING Service-Kubelet]: kubelet service is not enabled, please run 'systemctl enable kubelet.service'</div><div>[preflight] Pulling images required for setting up a Kubernetes cluster</div><div>[preflight] This might take a minute or two, depending on the speed of your internet connection</div><div>[preflight] You can also perform this action in beforehand using 'kubeadm config images pull'</div><div>[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;</div><div>[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;</div><div>[kubelet-start] Activating the kubelet service</div><div>[certs] Using certificateDir folder &quot;/etc/kubernetes/pki&quot;</div><div>[certs] Generating &quot;ca&quot; certificate and key</div><div>[certs] Generating &quot;apiserver&quot; certificate and key</div><div>[certs] apiserver serving cert is signed for DNS names [t0.wft.com kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 192.168.16.30]</div><div>[certs] Generating &quot;apiserver-kubelet-client&quot; certificate and key</div><div>[certs] Generating &quot;front-proxy-ca&quot; certificate and key</div><div>[certs] Generating &quot;front-proxy-client&quot; certificate and key</div><div>[certs] Generating &quot;etcd/ca&quot; certificate and key</div><div>[certs] Generating &quot;etcd/healthcheck-client&quot; certificate and key</div><div>[certs] Generating &quot;apiserver-etcd-client&quot; certificate and key</div><div>[certs] Generating &quot;etcd/peer&quot; certificate and key</div><div>[certs] etcd/peer serving cert is signed for DNS names [t0.wft.com localhost] and IPs [192.168.16.30 127.0.0.1 ::1]</div><div>[certs] Generating &quot;etcd/server&quot; certificate and key</div><div>[certs] etcd/server serving cert is signed for DNS names [t0.wft.com localhost] and IPs [192.168.16.30 127.0.0.1 ::1]</div><div>[certs] Generating &quot;sa&quot; key and public key</div><div>[kubeconfig] Using kubeconfig folder &quot;/etc/kubernetes&quot;</div><div>[kubeconfig] Writing &quot;admin.conf&quot; kubeconfig file</div><div>[kubeconfig] Writing &quot;kubelet.conf&quot; kubeconfig file</div><div>[kubeconfig] Writing &quot;controller-manager.conf&quot; kubeconfig file</div><div>[kubeconfig] Writing &quot;scheduler.conf&quot; kubeconfig file</div><div>[control-plane] Using manifest folder &quot;/etc/kubernetes/manifests&quot;</div><div>[control-plane] Creating static Pod manifest for &quot;kube-apiserver&quot;</div><div>[control-plane] Creating static Pod manifest for &quot;kube-controller-manager&quot;</div><div>[control-plane] Creating static Pod manifest for &quot;kube-scheduler&quot;</div><div>[etcd] Creating static Pod manifest for local etcd in &quot;/etc/kubernetes/manifests&quot;</div><div>[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory &quot;/etc/kubernetes/manifests&quot;. This can take up to 4m0s</div><div>[apiclient] All control plane components are healthy after 28.502478 seconds</div><div>[uploadconfig] storing the configuration used in ConfigMap &quot;kubeadm-config&quot; in the &quot;kube-system&quot; Namespace</div><div>[kubelet] Creating a ConfigMap &quot;kubelet-config-1.13&quot; in namespace kube-system with the configuration for the kubelets in the cluster</div><div>[patchnode] Uploading the CRI Socket information &quot;/var/run/dockershim.sock&quot; to the Node API object &quot;t0.wft.com&quot; as an annotation</div><div>[mark-control-plane] Marking the node t0.wft.com as control-plane by adding the label &quot;node-role.kubernetes.io/master=''&quot;</div><div>[mark-control-plane] Marking the node t0.wft.com as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]</div><div>[bootstrap-token] Using token: k4rp74.7ugxndmycj8rj0j4</div><div>[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</div><div>[bootstraptoken] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials</div><div>[bootstraptoken] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</div><div>[bootstraptoken] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster</div><div>[bootstraptoken] creating the &quot;cluster-info&quot; ConfigMap in the &quot;kube-public&quot; namespace</div><div>[addons] Applied essential addon: CoreDNS</div><div>[addons] Applied essential addon: kube-proxy</div><div><br/></div><div><br/></div><div>Your Kubernetes master has initialized successfully!</div><div><br/></div><div><br/></div><div>To start using your cluster, you need to run the following as a regular user:</div><div><br/></div><div><br/></div><div>  mkdir -p $HOME/.kube</div><div>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</div><div>  sudo chown $(id -u):$(id -g) $HOME/.kube/config</div><div><br/></div><div><br/></div><div>You should now deploy a pod network to the cluster.</div><div>Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</div><div>  https://kubernetes.io/docs/concepts/cluster-administration/addons/</div><div><br/></div><div><br/></div><div>You can now join any number of machines by running the following on each node</div><div>as root:</div><div><br/></div><div><br/></div><div>  kubeadm join 192.168.16.30:6443 --token k4rp74.7ugxndmycj8rj0j4 --discovery-token-ca-cert-hash sha256:b0834ceae59a1e77d3784a640a6ea1a91d82121fb4346d26f4f17a80f4fde1c0</div><div><br/></div><div>#将以上信息保留</div><div>token默认24小时过期，过期后使用kubeadm token create重新生成并修改原来命令</div></div><div><br/></div><div>## 验证是否要镜像下载下来</div><div>docker image ls</div><div><img src="2201 kubeadm部署k8s集群 docdker18_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>## 验证启动的容器</div><div>docker image ls</div><div><img src="2201 kubeadm部署k8s集群 docdker18_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>## 配置kubectl认证信息</div><div>mkdir -p $HOME/.kube</div><div>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</div><div>sudo chown $(id -u):$(id -g) $HOME/.kube/config</div><div><br/></div><div>## 查看是否配置成功</div><div>kubectl get cs</div><div><img src="2201 kubeadm部署k8s集群 docdker18_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>## 部署flannerl网络组件<a href="https://github.com/coreos/flannel">https://github.com/coreos/flannel</a></div><div>kubectl apply -f <a href="https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml">https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</a></div><div><br/></div><div>## 验证是否成功部署</div><div>### 查看是否成功下载flannel插件</div><div>docker image ls | grep flannel</div><div><br/></div><div>### 获取node状态是否ready状态</div><div>kubectl get nodes</div><div><img src="2201 kubeadm部署k8s集群 docdker18_files/Image [3].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>### 查看是否启动pod</div><div>kubectl get pods -n kube-system</div><div><img src="2201 kubeadm部署k8s集群 docdker18_files/Image [4].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>docker ps</div><div><img src="2201 kubeadm部署k8s集群 docdker18_files/Image [5].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>=========k8s的node节点============</div><div>## 配置docker的yum源</div><div>cd /etc/yum.repos.d</div><div>wget <a href="https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo">https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</a></div><div><br/></div><div># 配置k8s的yum源</div><div>vim kubernetes.repo</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[kubernetes]</div><div>name=k8s</div><div>baseurl=<a href="https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/">https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</a></div><div>gpgcheck=0</div><div>enable=1</div></div><div>yum repolist</div><div><br/></div><div>## 安装docker-ce的16.06版本</div><div>yum list docker-ce --showduplicates | sort -r</div><div>yum install docker-ce-18.06.0.ce-3.el7</div><div><br/></div><div># 将docker源修改为阿里云镜像加速器</div><div>mkdir /etc/docker/</div><div>vim /etc/docker/daemon.json</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>{</div><div>&quot;registry-mirrors&quot;: [&quot;<a href="https://88a45eyb.mirror.aliyuncs.com/">https://88a45eyb.mirror.aliyuncs.com&quot;,&quot;https://registry.docker-cn.com</a>&quot;],</div><div>&quot;dns&quot;: [&quot;223.5.5.5&quot;,&quot;223.6.6.6&quot;],</div><div>&quot;data-root&quot;: &quot;/data/docker&quot;</div><div>}</div></div><div><br/></div><div>## 打开ipvs转发功能</div><div>vim /etc/sysconfig/modules/ipvs.modules</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>#!/bin/bash</div><div>ipvs_mods_dir=&quot;/usr/lib/modules/$(uname -r)/kernel/net/netfilter/ipvs&quot;</div><div><br/></div><div>for i in $(ls $ipvs_mods_dir | grep -o &quot;^[^.]*&quot;); do</div><div>    /sbin/modinfo -F filename $i &amp;&gt; /dev/null</div><div>    if [ $? -eq 0 ]; then</div><div>        /sbin/modprobe $i</div><div>    fi    </div><div>done</div></div><div>chmod +x /etc/sysconfig/modules/ipvs.modules</div><div>/etc/sysconfig/modules/ipvs.modules</div><div><br/></div><div>##  配置docker使用代理</div><div>vim /usr/lib/systemd/system/docker.service</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div># 在ExecStart=/usr/bin/dockerd下面添加如下行</div><div>ExecStartPost=/usr/sbin/iptables -P FORWARD ACCEPT</div><div><br/></div><div># 在ExecReload=/bin/kill -s HUP $MAINPID添加如下行</div><div>Environment=&quot;HTTPS_PROXY=<a href="http://t6.wft:8118/">http://t6.wft.com:8118</a>&quot;</div><div>Environment=&quot;NO_PROXY=127.0.0.0/8,192.168.0.0/24,192.168.16.0/24&quot;</div></div><div><br/></div><div>systemctl enable docker</div><div>systemctl daemon-reload</div><div>systemctl restart docker</div><div>systemctl status docker</div><div><br/></div><div>## 测试是否可以通过代理下载镜像</div><div>docker pull k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1</div><div><br/></div><div>## 查看内核参数是否已经被修改如下</div><div>cat /proc/sys/net/bridge/bridge-nf-call-iptables</div><div>1   结果必须为1</div><div>cat /proc/sys/net/bridge/bridge-nf-call-ip6tables</div><div>1    结果必须为1</div><div><br/></div><div>## 安装k8s组件</div><div>yum install kubelet kubeadm kubectl</div><div><br/></div><div>## 配置kubelet</div><div>vim /etc/sysconfig/kubelet</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>KUBELET_EXTRA_ARGS=&quot;--fail-swap-on=false&quot;</div></div><div><br/></div><div><span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: 微软雅黑; font-variant-caps: normal; font-variant-ligatures: normal;">kubelet</span>初次不要直接启动,只设置开机启动就OK</div><div>systemctl enable kubelet.service</div><div><br/></div><div>## 将node节点加入集群</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>kubeadm join 192.168.16.30:6443 --token k4rp74.7ugxndmycj8rj0j4 --discovery-token-ca-cert-hash sha256:b0834ceae59a1e77d3784a640a6ea1a91d82121fb4346d26f4f17a80f4fde1c0 --ignore-preflight-errors=Swap</div></div><div><br/></div><div>## 加入集群需要一定时间</div><div>期间可以验证node节点查看是否有镜像下载下来与容器生成</div><div>docker image ls</div><div><img src="2201 kubeadm部署k8s集群 docdker18_files/Image [6].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>容器生成</div><div>docker ps -a</div><div><img src="2201 kubeadm部署k8s集群 docdker18_files/Image [7].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>在master节点上面验证节点状态</div><div>kubectl get nodes</div><div><img src="2201 kubeadm部署k8s集群 docdker18_files/Image [8].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: 微软雅黑; font-variant-caps: normal; font-variant-ligatures: normal;">在master节点上面查看集群是否有启动kube-proxy与flannel的pods</span></div><div>kubectl get pods -n kube-system -o wide</div><div><img src="2201 kubeadm部署k8s集群 docdker18_files/Image [9].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 